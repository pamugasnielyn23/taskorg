{% extends "organizer/base.html" %}

{% block title %}Dashboard | TASK.IO{% endblock %}

{% block content %}
<style>
    /* Dashboard Specific Styles */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
    }

    .welcome-section {
        margin-bottom: -0.5rem;
        animation: fadeIn 0.8s ease;
    }

    .welcome-section h1 {
        font-size: 2.25rem;
        font-weight: 800;
        letter-spacing: -0.04em;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .username-input {
        background: transparent;
        border: none;
        padding: 0;
        font: inherit;
        color: inherit;
        width: auto;
        min-width: 100px;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: text;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        border-radius: 8px;
    }

    .username-input:hover,
    .username-input:focus {
        -webkit-text-fill-color: var(--text-primary);
        background: var(--bg-hover);
        border-bottom-color: var(--brand-primary);
        outline: none;
        padding: 0 0.5rem;
    }

    .welcome-section p {
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.95rem;
    }

    /* Premium Analytics Overhaul */
    .analytics-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .analytics-card {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .analytics-header h2 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.01em;
    }

    .weekly-chart {
        height: 140px;
        display: flex;
        align-items: flex-end;
        gap: 12px;
        padding: 10px 0 20px;
    }

    .chart-bar-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        height: 100%;
        justify-content: flex-end;
    }

    .chart-bar {
        width: 100%;
        background: linear-gradient(to top, var(--brand-primary), var(--brand-secondary));
        border-radius: 6px;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        min-height: 4px;
    }

    .chart-bar:hover {
        filter: brightness(1.2);
        transform: scaleX(1.1);
    }

    .bar-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .score-display {
        text-align: center;
        padding: 1rem;
    }

    .score-circle-outer {
        width: 120px;
        height: 120px;
        margin: 0 auto 1.5rem;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .score-circle-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .score-circle-bg {
        fill: none;
        stroke: var(--bg-hover);
        stroke-width: 8;
    }

    .score-circle-value {
        fill: none;
        stroke: var(--brand-primary);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dasharray 1s ease;
    }

    .score-text {
        position: absolute;
        font-family: 'Outfit';
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--brand-primary);
    }

    /* Stats Cards Premium */
    .stats-tray {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-pill {
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        transition: all 0.3s ease;
    }

    .stat-pill:hover {
        transform: translateY(-4px);
        background: var(--bg-card);
    }

    .stat-icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        background: var(--bg-hover);
    }

    .stat-data .value {
        font-size: 1.5rem;
        font-weight: 800;
        font-family: 'Outfit';
        line-height: 1;
        color: var(--text-primary);
    }

    .stat-data .label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Actions Bar */
    .controls-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .search-pill {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 14px;
        padding: 0.2rem 0.5rem 0.2rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 320px;
        max-width: 100%;
        transition: all 0.3s ease;
    }

    .search-pill:focus-within {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 4px hsla(260, 70%, 60%, 0.1);
    }

    .search-pill input {
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-primary);
        padding: 0.6rem 0;
        width: 100%;
        font-weight: 500;
    }

    .filter-group {
        display: flex;
        background: var(--bg-hover);
        padding: 0.3rem;
        border-radius: 12px;
        gap: 0.25rem;
    }

    .filter-chip {
        padding: 0.5rem 1.25rem;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 700;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-chip.active {
        background: var(--bg-card);
        color: var(--brand-primary);
        box-shadow: var(--shadow-sm);
    }

    /* Task Card Evolution */
    .task-stack {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.5rem;
    }

    .task-card {
        padding: 1.75rem;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 100%;
        background: var(--brand-primary);
    }

    .task-card.priority-high::before {
        background: var(--danger);
    }

    .task-card.priority-medium::before {
        background: var(--warning);
    }

    .task-card.priority-low::before {
        background: var(--success);
    }

    .task-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: var(--shadow-lg);
    }

    .task-card .title {
        font-size: 1.15rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-desc {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .task-meta-tray {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .meta-tag {
        padding: 0.3rem 0.75rem;
        border-radius: 8px;
        background: var(--bg-hover);
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .meta-tag.overdue {
        background: hsla(0, 85%, 60%, 0.1);
        color: var(--danger);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .task-action-btn {
        padding: 0.6rem;
        border-radius: 10px;
        text-decoration: none;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 700;
        border: 1px solid var(--border-color);
        background: var(--bg-hover);
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .task-action-btn:hover {
        background: var(--bg-card);
        border-color: var(--brand-primary);
        color: var(--brand-primary);
    }

    .btn-done {
        background: hsla(160, 80%, 40%, 0.1);
        color: var(--success);
        border-color: transparent;
    }

    .btn-done:hover {
        background: var(--success);
        color: white;
    }

    .hidden {
        display: none !important;
    }

    @media (max-width: 900px) {
        .analytics-section {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="welcome-section">
    <h1>Welcome back,
        <input type="text" class="username-input" value="{{ user.username }}" id="dashUsername"
            onblur="updateUsername(this.value)" onkeydown="if(event.key==='Enter') this.blur()"
            title="Click to edit username">
    </h1>
    <p>Operational status is nominal. You have <span style="color: var(--brand-primary); font-weight: 700;"
            id="welcomePending">0</span> objectives pending.</p>
</div>

<div class="dashboard-grid">
    <!-- Premium Analytics -->
    <div class="analytics-section">
        <div class="glass-card analytics-card">
            <div class="analytics-header">
                <h2>📈 WEEKLY ANALYTICS</h2>
                <div class="meta-tag">PAST 7 DAYS</div>
            </div>
            <div class="weekly-chart">
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 40%"></div>
                    <span class="bar-label">Mon</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 70%"></div>
                    <span class="bar-label">Tue</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 55%"></div>
                    <span class="bar-label">Wed</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 90%"></div>
                    <span class="bar-label">Thu</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 30%"></div>
                    <span class="bar-label">Fri</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 60%"></div>
                    <span class="bar-label">Sat</span>
                </div>
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: 85%"></div>
                    <span class="bar-label">Sun</span>
                </div>
            </div>
        </div>

        <div class="glass-card analytics-card score-display">
            <div class="analytics-header">
                <h2>🎯 DAILY SCORE</h2>
            </div>
            <div class="score-circle-outer">
                <svg class="score-circle-svg" viewBox="0 0 100 100">
                    <circle class="score-circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle id="scoreProgress" class="score-circle-value" cx="50" cy="50" r="45"
                        stroke-dasharray="0 283"></circle>
                </svg>
                <div class="score-text" id="prodScore">0</div>
            </div>
            <p style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">
                Optimization Rating</p>
        </div>
    </div>

    <!-- Quick Stats Tray -->
    <div class="stats-tray">
        <div class="glass-card stat-pill">
            <div class="stat-icon-box">📊</div>
            <div class="stat-data">
                <div class="value">{{ tasks.count }}</div>
                <div class="label">Total Tasks</div>
            </div>
        </div>
        <div class="glass-card stat-pill">
            <div class="stat-icon-box">⏳</div>
            <div class="stat-data">
                <div class="value" id="pendingCount">0</div>
                <div class="label">Pending</div>
            </div>
        </div>
        <div class="glass-card stat-pill">
            <div class="stat-icon-box">✨</div>
            <div class="stat-data">
                <div class="value" id="completedCount">0</div>
                <div class="label">Fulfilled</div>
            </div>
        </div>
        <div class="glass-card stat-pill">
            <div class="stat-icon-box">🔥</div>
            <div class="stat-data">
                <div class="value" id="overdueCount">0</div>
                <div class="label">Overdue</div>
            </div>
        </div>
    </div>

    <!-- Controls & Filters -->
    <div class="controls-bar">
        <div class="search-pill">
            <span>🔍</span>
            <input type="text" id="searchInput" placeholder="Scan identifiers..." onkeyup="searchTasks()">
        </div>
        <div class="filter-group">
            <button class="filter-chip active" data-filter="all" onclick="filterTasks('all')">ALL</button>
            <button class="filter-chip" data-filter="pending" onclick="filterTasks('pending')">ACTIVE</button>
            <button class="filter-chip" data-filter="completed" onclick="filterTasks('completed')">DONE</button>
            <button class="filter-chip" data-filter="high" onclick="filterTasks('high')">URGENT</button>
            <button class="filter-chip" data-filter="medium" onclick="filterTasks('medium')">MEDIUM</button>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <select class="filter-chip" id="sortSelect" onchange="sortTasks()"
                style="background: var(--bg-card); cursor: pointer; border: 1px solid var(--border-color);">
                <option value="newest">NEWEST</option>
                <option value="oldest">OLDEST</option>
                <option value="due-date">SCHEDULE</option>
                <option value="priority">PRIORITY</option>
            </select>
            <a href="{% url 'task_create' %}" class="btn-premium">⚡ ADD TASK</a>
        </div>
    </div>

    <!-- Tasks Collection -->
    <div class="task-stack" id="tasksContainer">
        {% if tasks %}
        {% for task in tasks %}
        <div class="glass-card task-card priority-{{ task.priority|lower }}" data-priority="{{ task.priority|lower }}"
            data-status="{{ task.status|lower }}" data-title="{{ task.title|lower }}"
            data-due="{{ task.due_date|date:'Y-m-d'|default:'' }}" data-created="{{ task.created_at|date:'Y-m-d' }}"
            data-overdue="{% if task.is_overdue %}true{% else %}false{% endif %}">

            <div class="title">
                {{ task.title }}
                {% if task.recurrence != 'none' %}
                <span title="Automated Core: {{ task.recurrence }}" style="opacity: 0.6;">🔄</span>
                {% endif %}
            </div>

            {% if task.description %}
            <p class="task-desc">{{ task.description }}</p>
            {% endif %}

            <div class="task-meta-tray">
                {% if task.due_date %}
                <span class="meta-tag {% if task.is_overdue %}overdue{% endif %}">
                    📅 {{ task.due_date|date:"M d" }}
                </span>
                {% endif %}
                <span class="meta-tag">📌 {{ task.status|upper }}</span>
                {% if task.category %}
                <span class="meta-tag">🏷️ {{ task.category|upper }}</span>
                {% endif %}
            </div>

            <div class="actions-grid">
                <button class="task-action-btn" onclick="startFocus('{{ task.title|escapejs }}')"
                    style="background: hsla(260, 70%, 60%, 0.1); border-color: transparent; color: var(--brand-primary);">
                    ⏱️ FOCUS
                </button>
                <a href="{% url 'task_update' task.pk %}" class="task-action-btn">✏️ EDIT</a>
                {% if task.status != 'Completed' %}
                <a href="{% url 'task_complete' task.pk %}" class="btn-done task-action-btn">✅ COMPLETE</a>
                {% endif %}
                <a href="{% url 'task_vault' task.pk %}" class="task-action-btn">📦 ARCHIVE</a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="glass-card" style="grid-column: 1/-1; padding: 5rem; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">🛰️</div>
            <h3 style="font-family: 'Outfit'; margin-bottom: 0.5rem;">WORKSPACE EMPTY</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Ready for mission deployment? Create your first
                task.</p>
        </div>
        {% endif %}
    </div>
</div>



<script>
    function updateUsername(newUsername) {
        if (!newUsername || newUsername.trim() === '') return;

        fetch('{% url "update_username" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ username: newUsername })
        })
            .then(response => {
                if (response.ok) {
                    const input = document.getElementById('dashUsername');
                    input.style.borderBottomColor = 'var(--success)';
                    setTimeout(() => input.style.borderBottomColor = 'transparent', 1500);
                } else {
                    response.json().then(data => {
                        alert('Update failed: ' + (data.message || 'Unknown error'));
                        location.reload();
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('A network error occurred.');
            });
    }


    function updateStats() {
        const cards = document.querySelectorAll('.task-card');
        let pending = 0, completed = 0, overdue = 0;
        cards.forEach(c => {
            if (c.dataset.status === 'completed') completed++;
            else pending++;
            if (c.dataset.overdue === 'true') overdue++;
        });

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('welcomePending').textContent = pending;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('overdueCount').textContent = overdue;

        const score = cards.length ? Math.round((completed / cards.length) * 100) : 0;
        document.getElementById('prodScore').textContent = score;

        // Update Circle Progress
        const circle = document.getElementById('scoreProgress');
        const radius = 45;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = offset;
    }

    function searchTasks() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.task-card').forEach(c => {
            c.classList.toggle('hidden', !c.dataset.title.includes(q));
        });
    }

    function filterTasks(f) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
        document.querySelectorAll('.task-card').forEach(c => {
            if (f === 'all') c.classList.remove('hidden');
            else if (f === 'pending') c.classList.toggle('hidden', c.dataset.status === 'completed');
            else if (f === 'completed') c.classList.toggle('hidden', c.dataset.status !== 'completed');
            else if (f === 'high') c.classList.toggle('hidden', c.dataset.priority !== 'high');
            else if (f === 'medium') c.classList.toggle('hidden', c.dataset.priority !== 'medium');
        });
    }

    function sortTasks() {
        const s = document.getElementById('sortSelect').value;
        const container = document.getElementById('tasksContainer');
        const tasks = Array.from(container.querySelectorAll('.task-card'));
        tasks.sort((a, b) => {
            if (s === 'newest') return new Date(b.dataset.created) - new Date(a.dataset.created);
            if (s === 'oldest') return new Date(a.dataset.created) - new Date(b.dataset.created);
            if (s === 'priority') {
                const p = { high: 1, medium: 2, low: 3 };
                const vA = p[a.dataset.priority] || 4;
                const vB = p[b.dataset.priority] || 4;
                return vA - vB;
            }
            if (s === 'due-date') return (new Date(a.dataset.due || '9999')) - (new Date(b.dataset.due || '9999'));
            return 0;
        });
        tasks.forEach(t => container.appendChild(t));
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateStats();

        // Staggered entry for task cards
        document.querySelectorAll('.task-card').forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100 * index);
        });
    });
</script>
{% endblock %}